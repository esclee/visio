WITH obj AS
(
  SELECT "BI_OPERATION".OPERATIONID
       , "BI_PLAN".PLANID
       , "BI_PLAN".PLANNINGYEAR                   AS PLANNINGYEAR
       , "BI_PRJPOPULATIONGROUP".MSRPCODE         AS PPG_CODE
       , "BI_PRJPOPULATIONGROUP".ORIGPOPGROUP_ID  AS PPGID
       , "BI_GOAL".RFGOALID
       , "BI_RIGHTSGROUP".RFRIGHTSGROUPID
       , "BI_OBJECTIVE".OBJECTIVEID OBJID
       , "BI_OBJECTIVE".RFPROBLEMOBJECTIVEID
       , "BI_OBJECTIVE".TAG                       AS EXCLUDED
  FROM   "BI_OPERATION"
  INNER JOIN "BI_PLAN"                ON   "BI_OPERATION"."OPERATIONID"="BI_PLAN"."OPERATIONID"
  INNER JOIN "BI_PRJPOPULATIONGROUP"  ON  "BI_PLAN"."PLANID"="BI_PRJPOPULATIONGROUP"."PLANID"
  INNER JOIN "BI_GOAL"                ON  "BI_PRJPOPULATIONGROUP"."POPULATIONGROUP_ID"="BI_GOAL"."POPULATIONGROUPID"
  INNER JOIN "BI_RFGOALS"             ON "BI_GOAL"."RFGOALID" = "BI_RFGOALS"."ID"
  INNER JOIN "BI_RIGHTSGROUP"         ON  "BI_GOAL"."GOALID"="BI_RIGHTSGROUP"."GOALID"
  INNER JOIN "BI_RFRIGHTSGROUP"       ON "BI_RIGHTSGROUP"."RFRIGHTSGROUPID" = "BI_RFRIGHTSGROUP"."ID"
  INNER JOIN "BI_OBJECTIVE"           ON  "BI_RIGHTSGROUP"."RIGHTSGROUPID"="BI_OBJECTIVE"."RIGHTSGROUPID"
  INNER JOIN "BI_RFPROBLOBJ"          ON "BI_OBJECTIVE"."RFPROBLEMOBJECTIVEID" = "BI_RFPROBLOBJ"."ID"
  WHERE PLANNINGYEAR >= 2012 AND
        PLANNINGSTAGE = 8
)

SELECT obj.*
     , "BI_IMPACTINDICATOR".ID                          AS IMPINDICATOR_RFID
     , "BI_OBJIMPACTINDICATOR".ID                       AS IMPINDICATOR_ID
     , ROUND("BI_OBJIMPACTINDICATOR".IMP_TARGET)      AS IMP_IMP_TARGET
     , ROUND("BI_OBJIMPACTINDICATOR".COMP_TARGET)     AS IMP_COMP_TARGET
     , ROUND("BI_OBJIMPACTINDICATOR".MID_YEAR_VALUE)  AS IMP_MID_YEAR_VALUE
     , ROUND("BI_OBJIMPACTINDICATOR".YEAR_END_VALUE)  AS IMP_YEAR_END_VALUE
     , ROUND("BI_OBJIMPACTINDICATOR".BASELINE)        AS IMP_BASELINE
     , ROUND("BI_IMPACTINDICATOR".STANDARDVALUE)      AS IMP_STANDARD
     , ROUND("BI_IMPACTINDICATOR".GREENVALUE)         AS IMP_GREEN
     , ROUND("BI_IMPACTINDICATOR".REDVALUE)           AS IMP_RED
     , ROUND("BI_IMPACTINDICATOR".ISREVERSAL)         AS REVERSAL
     , OBJ_PRIORITY.PRIORITY
     , "BI_IMPACTINDICATOR".TYPE                      AS INDICATOR_TYPE
FROM obj
LEFT OUTER JOIN "BI_IMPACTINDICATOR"  ON "RFPROBLEMOBJECTIVEID" = "BI_IMPACTINDICATOR"."RFPROBOBJ_ID"
INNER JOIN
      -- This table computes the priority of an objective based on the output
      (SELECT obj.OBJECTIVEID,
        CASE WHEN MAX(og.tag) = MIN(og.tag) THEN MAX(og.tag)
          ELSE 'Partially Prioritized'
        END AS PRIORITY
      FROM FOCUS_BI.BI_OBJECTIVE obj
      JOIN FOCUS_BI.BI_OUTPUTGRP og ON og.OBJECTIVEID = obj.OBJECTIVEID
      GROUP BY obj.OBJECTIVEID) OBJ_PRIORITY  on OBJ_PRIORITY.OBJECTIVEID = "OBJID"
INNER JOIN "BI_OBJIMPACTINDICATOR"    ON "BI_IMPACTINDICATOR".ID="BI_OBJIMPACTINDICATOR".INDICATOR_ID
